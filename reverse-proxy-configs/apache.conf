# Apache configuration for AirMessage Connect
# File: /etc/apache2/sites-available/airmessage-connect.conf
# Enable with: sudo a2ensite airmessage-connect

# Required modules:
# sudo a2enmod proxy proxy_http proxy_wstunnel ssl headers rewrite

<VirtualHost *:80>
    ServerName airmessage.vanstek.dev
    
    # Allow Let's Encrypt verification
    Alias /.well-known/acme-challenge/ /var/www/html/.well-known/acme-challenge/
    <Directory "/var/www/html/.well-known/acme-challenge/">
        Options None
        AllowOverride None
        Require all granted
    </Directory>
    
    # Redirect to HTTPS
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName airmessage.vanstek.dev
    
    # SSL certificate paths (adjust to your setup)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/airmessage.vanstek.dev/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/airmessage.vanstek.dev/privkey.pem
    
    # SSL configuration - modern security settings
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    
    # Security headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/airmessage-connect-error.log
    CustomLog ${APACHE_LOG_DIR}/airmessage-connect-access.log combined
    
    # WebSocket proxy configuration
    ProxyPreserveHost On
    ProxyRequests Off
    
    # WebSocket proxy to backend
    ProxyPass / ws://127.0.0.1:1259/
    ProxyPassReverse / ws://127.0.0.1:1259/
    
    # Set headers for WebSocket
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    
    # Timeout settings for long-lived connections
    ProxyTimeout 86400
</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
